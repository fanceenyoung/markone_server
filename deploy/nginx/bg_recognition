# main nginx settings, copy to /etc/nginx/sites-available/

upstream markone_server-backend {
    server 127.0.0.1:11112 fail_timeout=0;
}

server {

  listen 80 default;
  server_name 0.0.0.0;
  # server_name zhangtianyi.club;

  error_page    404 = /404.html;
  error_page    500 = /500.html;
  client_max_body_size 20M;

  location ~ /static/(?P<file>.*) {
    root /var/markone_server/staticfiles;
    try_files /static/$file /$file =404;
    expires 30d;
    gzip on;
    gzip_types text/plain application/x-javascript text/css application/javascript;
    gzip_comp_level 3;
  }

  location ^~ /admin/ {
    proxy_pass http://markone_server-backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    allow 10.0.0.0/16;
    allow 192.168.0.0/16;
    deny all;
  }

  location = /404.html {
    root /root/markone_server/templates;
    internal;
  }

  location = /500.html {
    root /root/markone_server/templates;
    internal;
  }

  location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://markone_server-backend;
  }
}

server {

  listen 80;
  # server_name markone_server-cms.zhangtianyi.club;
  server_name 0.0.0.0;

  client_max_body_size 20M;

  location ~ /static/(?P<file>.*) {
    root /var/markone_server-cms/staticfiles;
    try_files /static/$file /$file =404;
    expires 30d;
    gzip on;
    gzip_types text/plain application/x-javascript text/css application/javascript;
    gzip_comp_level 3;
  }

  location ^~ /admin/ {
    proxy_pass http://markone_server-backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # allow 10.0.0.0/16;
    allow 192.168.0.0/16;
    deny all;
  }

  location / {
    root /var/markone_server-cms;
    try_files $uri $uri/ /index.html;
  }

  location /api/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://markone_server-backend;
  }
}
